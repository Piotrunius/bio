name: Deploy All (Full Manual)

on:
  workflow_dispatch:

concurrency:
  group: pages-flow
  cancel-in-progress: false

jobs:
  full-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Fetch and Update Data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
          STEAM_ID64: ${{ secrets.STEAM_ID64 }}
        run: |
          # 1. STEAM UPDATE
          cat << 'EOF' > steam.js
          const fs = require('fs');
          const key = process.env.STEAM_API_KEY;
          const id = process.env.STEAM_ID64 || '76561199034113344';
          async function run() {
            try {
              const sR = await fetch(`http://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=${key}&steamids=${id}`);
              const sJ = await sR.json();
              const gR = await fetch(`http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key=${key}&steamid=${id}&include_appinfo=0&include_played_free_games=1`);
              const gJ = await gR.json();
              const p = sJ.response.players[0];
              const stats = {
                steam: {
                  personastate: p.personastate, gameextrainfo: p.gameextrainfo || null, avatar: p.avatarmedium,
                  timecreated: p.timecreated, lastlogoff: p.lastlogoff, game_count: gJ.response?.game_count || 0,
                  total_playtime: Math.round((gJ.response?.games?.reduce((a,b)=>a+(b.playtime_forever||0),0)||0)/60)
                },
                lastUpdate: new Date().toISOString()
              };
              fs.writeFileSync('./data/steam-status.json', JSON.stringify(stats, null, 2));
            } catch (e) { console.error(e); }
          }
          run();
          EOF
          
          # 2. GITHUB UPDATE
          cat << 'EOF' > github.js
          const fs = require('fs');
          const user = 'Piotrunius';
          const headers = process.env.GITHUB_TOKEN ? { 'Authorization': `token ${process.env.GITHUB_TOKEN}` } : {};
          async function run() {
            try {
              const uR = await fetch(`https://api.github.com/users/${user}`, { headers });
              const uJ = await uR.json();
              const sR = await fetch(`https://api.github.com/users/${user}/starred?per_page=100`, { headers: {...headers, 'Accept': 'application/vnd.github.star+json'} });
              const starred = await sR.json();
              const cR = await fetch(`https://api.github.com/search/commits?q=author:${user}`, { headers: {...headers, 'Accept': 'application/vnd.github.cloak-preview'} });
              const cJ = await cR.json();
              const stats = {
                summary: { projects: uJ.public_repos, starredCount: Array.isArray(starred) ? starred.length : 0, commits: cJ.total_count || 0 },
                starred: Array.isArray(starred) ? starred.slice(0, 30).map(i => ({
                  name: i.repo.name, owner: i.repo.owner.login, url: i.repo.html_url, stars: i.repo.stargazers_count,
                  language: i.repo.language, description: i.repo.description, starredAt: i.starred_at
                })) : [],
                recentCommits: [], lastUpdate: new Date().toISOString()
              };
              const reposR = await fetch(`https://api.github.com/users/${user}/repos?sort=updated&per_page=5`, { headers });
              const repos = await reposR.json();
              for (const r of repos) {
                const cr = await fetch(`https://api.github.com/repos/${user}/${r.name}/commits?per_page=5`, { headers });
                const cm = await cr.json();
                if (Array.isArray(cm)) {
                  stats.recentCommits = stats.recentCommits.concat(cm.map(c => ({
                    message: c.commit.message.split('\n')[0], repo: r.name, author: c.commit.author.name, date: c.commit.author.date, url: c.html_url
                  })));
                }
              }
              stats.recentCommits.sort((a,b) => new Date(b.date) - new Date(a.date));
              fs.writeFileSync('./data/github-stats.json', JSON.stringify(stats, null, 2));
            } catch (e) { console.error(e); }
          }
          run();
          EOF
          
          if (!fs.existsSync('./data')) fs.mkdirSync('./data');
          node steam.js
          node github.js

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/*.json
          git diff --staged --quiet || (git commit -m "chore: full manual stats update" && git pull --rebase origin main && git push origin main)

  deploy:
    needs: full-update
    uses: ./.github/workflows/deploy.yml
